<script src="{{ 'product-info.js' | asset_url }}" defer="defer"></script>
{% style %}
  .product-grid-block-{{ section.id }} {
    background: {{ section.settings.bg-color }};
  }
  .product-grid-innerblock-{{ section.id }} .product-grid-heading {
    color: {{ section.settings.title_color }}
  }
  button.primary-btn {
    background-color: #000000;
    color: #fff;
    }
    button.primary-btn:hover {
    color: #000000;
    }
    button.primary-btn::before {
    background-color: #FFF544;
    }
    button.primary-btn:hover svg path {
        fill: #000000;
    }
{% endstyle %}

<div class="product-grid-block product-grid-block-{{ section.id }}">
    <div class="primary-container">
        <div class="product-grid-innerblock product-grid-innerblock-{{ section.id }}">
            <h2 class="product-grid-heading">
                {{ section.settings.title }}
            </h2>
            <div class="product-grid-area">
                {% for block in section.blocks %}
                    {% assign card_product = block.settings.select_product %}
                    {% style %}
                      .product-grid-overlay-add-{{ block.id }} {
                        top: {{ block.settings.top_desktop }}%;
                        left: {{ block.settings.left_desktop }}%;
                        transform: translate(-{{ block.settings.top_desktop }}%, -{{ block.settings.left_desktop }}%);
                      }
                      @media only screen and (max-width: 768px) {
                        .product-grid-overlay-add-{{ block.id }} {
                            top: {{ block.settings.top_mobile }}%;
                            left: {{ block.settings.left_mobile }}%;
                            transform: translate(-{{ block.settings.top_mobile }}%, -{{ block.settings.left_mobile }}%);
                        }
                      }
                    {% endstyle %}
                    <div class="product-grid" {{ block.shopify_attributes }}>
                        <div class="product-grid-img">
                            <img
                                src="{{ card_product.featured_image | image_url: width: 433 }}"
                                alt="{{ card_product.featured_image.alt | escape }}"
                                width="433"
                                height="444"
                                loading="lazy"
                            >
                            <span class="product-grid-overlay-add product-grid-overlay-add-{{ block.id }}" onclick="togglePopup('popup-{{ block.id }}')">
                                <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M4.98047 0.75V9.21154" stroke="black" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="round"/>
                                    <path d="M0.75 4.98071H9.21154" stroke="black" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="round"/>
                                </svg>
                            </span>
                            <div id="popup-{{ block.id }}" class="product-popup">
                                <div class="product-popup-innerblock">
                                    <span class="close-popup" onclick="togglePopup('popup-{{ block.id }}')">
                                        <svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.24219 4.24279L12.7275 12.7281" stroke="black" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="round"/>
                                        <path d="M4.24219 12.7278L12.7275 4.24249" stroke="black" stroke-width="1.5" stroke-linecap="square" stroke-linejoin="round"/>
                                        </svg>
                                    </span>
                                    <div class="product-popup-img-content">
                                        <div class="product-popup-img-block">
                                            <img
                                                src="{{ card_product.featured_image | image_url: width: 120 }}"
                                                alt="{{ card_product.featured_image.alt | escape }}"
                                                width="120"
                                                height="140"
                                                loading="lazy"
                                            >
                                        </div>
                                        <div class="product-popup-content-title-price-desc">
                                            <h3 class="product-popup-content-title">{{ card_product.title }}</h3>
                                            <span class="product-popup-content-price">{{ card_product.price | money }}</span>
                                            <div class="product-popup-content-desc">
                                                {{ card_product.content }}
                                            </div>
                                        </div>
                                    </div>
                                    {% comment %} Variant {% endcomment %}
                                    <form method="post" action="/cart/add" class="product-popup-variant-block" id="product-form-{{ block.id }}">
                                
                                        <input type="hidden" name="id" value="{{ card_product.selected_or_first_available_variant.id }}" class="product-variant-id">
                                        
                                        <script type="application/json" class="variant-data">
                                        [
                                            {% for variant in card_product.variants %}
                                            {
                                                "id": {{ variant.id }},
                                                "price": "{{ variant.price | money }}",
                                                "options": {{ variant.options | json }}
                                            }{% unless forloop.last %},{% endunless %}
                                            {% endfor %}
                                        ]
                                        </script>

                                        {% unless card_product.has_only_default_variant %}
                                        {% for option in card_product.options_with_values %}
                                            <div class="variant-group">
                                            <p class="variant-label">{{ option.name }}</p>
                                            
                                            {% if option.name == 'Color' or option.name == 'Colour' %}
                                                <div class="variant-swatches">
                                                {% for value in option.values %}
                                                    <input type="radio" 
                                                        class="single-option-selector"
                                                        data-index="{{ forloop.parentloop.index0 }}"
                                                        id="swatch-{{ block.id }}-{{ option.name }}-{{ forloop.index }}" 
                                                        name="options[{{ option.name }}-{{ block.id }}]" 
                                                        value="{{ value | escape }}"
                                                        {% if option.selected_value == value %}checked{% endif %}>
                                                    <label for="swatch-{{ block.id }}-{{ option.name }}-{{ forloop.index }}" 
                                                        class="swatch-label"
                                                        style="--swatch-color: {{ value | downcase }};">
                                                    {{ value }}
                                                    </label>
                                                {% endfor %}
                                                </div>

                                            {% else %}
                                                <div class="size-select-wrapper">
                                                <select class="single-option-selector" 
                                                        data-index="{{ forloop.index0 }}"
                                                        onchange="this.nextElementSibling.querySelector('.size-text').innerText = this.value">
                                                    {% for value in option.values %}
                                                    <option value="{{ value | escape }}" {% if option.selected_value == value %}selected{% endif %}>
                                                        {{ value }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                                
                                                <div class="variant-size-selector">
                                                    <span class="size-text">
                                                        {{ option.selected_value }}
                                                    </span>
                                                    <span class="size-arrow">
                                                        <svg width="14" height="8" viewBox="0 0 14 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M1 1L7 7L13 1" stroke="black" stroke-width="1.5" stroke-linecap="square"/>
                                                        </svg>
                                                    </span>
                                                </div>
                                                </div>
                                            {% endif %}
                                            </div>
                                        {% endfor %}
                                        {% endunless %}

                                        <button type="submit" class="popup-add-btn primary-btn">
                                            <span>ADD TO CART</span>
                                            <svg width="36" height="12" viewBox="0 0 36 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M0.75 4.77295L9.20657e-08 4.77295L-9.20657e-08 6.27295L0.75 6.27295L0.75 4.77295ZM34.9798 6.05328C35.2727 5.76039 35.2727 5.28551 34.9798 4.99262L30.2068 0.21965C29.9139 -0.0732432 29.4391 -0.0732433 29.1462 0.21965C28.8533 0.512544 28.8533 0.987417 29.1462 1.28031L33.3888 5.52295L29.1462 9.76559C28.8533 10.0585 28.8533 10.5334 29.1462 10.8263C29.4391 11.1191 29.9139 11.1191 30.2068 10.8263L34.9798 6.05328ZM0.75 6.27295L34.4495 6.27295L34.4495 4.77295L0.75 4.77295L0.75 6.27295Z" fill="currentColor"/>
                                            </svg>
                                        </button>
                                    </form>
                                    {% comment %}  {% endcomment %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
  // 1. Popup Toggle Logic
  function togglePopup(popupId) {
    var popup = document.getElementById(popupId);
    var allPopups = document.querySelectorAll('.product-popup');
    
    // Close other popups
    allPopups.forEach(function(el) {
      if (el.id !== popupId) {
        el.classList.remove('active');
      }
    });

    if (popup) {
      if (popup.classList.contains('active')) {
        popup.classList.remove('active');
        document.documentElement.style.overflow = '';
        document.body.style.overflow = ''; 
      } else {
        popup.classList.add('active');
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
      }
    }
  }

  // 2. Variant Change Logic
  document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.product-popup-variant-block');
    
    forms.forEach(form => {
        
        const scriptTag = form.querySelector('.variant-data');
        if (!scriptTag) return;
        
        const variants = JSON.parse(scriptTag.textContent);
        const inputs = form.querySelectorAll('.single-option-selector');
        const hiddenInput = form.querySelector('.product-variant-id');
       
        const priceElement = form.closest('.product-popup-innerblock').querySelector('.product-popup-content-price');

        inputs.forEach(input => {
            input.addEventListener('change', () => {
                
                let selectedOptions = [];
                
                inputs.forEach(item => {
                    if (item.tagName === 'SELECT') {
                        selectedOptions[item.getAttribute('data-index')] = item.value;
                    } else if (item.type === 'radio' && item.checked) {
                        selectedOptions[item.getAttribute('data-index')] = item.value;
                    }
                });

                const matchedVariant = variants.find(variant => {
                    return variant.options.every((optionValue, index) => {
                         return optionValue === selectedOptions[index];
                    });
                });

                
                if (matchedVariant) {
                    if (hiddenInput) hiddenInput.value = matchedVariant.id;
                    if (priceElement) priceElement.innerText = matchedVariant.price;
                }
            });
        });
    });
  });
</script>

{% schema %}
{
    "name": "Product Grid",
    "tag": "section",
    "class": "product-grid-sc",
    "settings": [
        {
            "type": "color_background",
            "id": "bg_color",
            "label": "Background Color",
            "default": "#ffffff"
        },
        {
            "type": "color",
            "id": "title_color",
            "label": "Title Color",
            "default": "#000000"
        },
        {
            "type": "inline_richtext",
            "id": "title",
            "label": "Title"
        }
    ],
    "blocks": [
        {
            "type": "products",
            "name": "Product",
            "settings": [
                {
                    "type": "product",
                    "id": "select_product",
                    "label": "Select Product"
                },
                {
                    "type": "range",
                    "id": "top_desktop",
                    "min": 0,
                    "max": 100,
                    "unit": "%",
                    "step": 1.0,
                    "label": "Top (desktop)",
                    "default": 50
                },
                {
                    "type": "range",
                    "id": "left_desktop",
                    "min": 0,
                    "max": 100,
                    "unit": "%",
                    "step": 1.0,
                    "label": "Left (desktop)",
                    "default": 50
                },
                {
                    "type": "range",
                    "id": "top_mobile",
                    "min": 0,
                    "max": 100,
                    "unit": "%",
                    "step": 1.0,
                    "label": "Top (mobile)",
                    "default": 50
                },
                {
                    "type": "range",
                    "id": "left_mobile",
                    "min": 0,
                    "max": 100,
                    "unit": "%",
                    "step": 1.0,
                    "label": "Left (mobile)",
                    "default": 50
                }
            ]
        }
    ],
    "presets": [
        {
            "name": "Product Grid"
        }
    ]
}
{% endschema %}